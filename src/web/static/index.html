<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A11y Remediation — Document Accessibility</title>
  <style>
    :root {
      --bg: #f6f7f9;
      --surface: #ffffff;
      --border: #e2e5ea;
      --text: #1a1d23;
      --text-secondary: #5f6672;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --success: #16a34a;
      --success-bg: #f0fdf4;
      --warning: #d97706;
      --warning-bg: #fffbeb;
      --error: #dc2626;
      --error-bg: #fef2f2;
      --radius: 10px;
      --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
      --shadow-lg: 0 4px 12px rgba(0,0,0,0.08);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
    }

    /* Skip nav */
    .skip-nav {
      position: absolute;
      top: -100%;
      left: 0;
      background: var(--accent);
      color: white;
      padding: 0.5rem 1rem;
      z-index: 300;
      font-size: 0.85rem;
      text-decoration: none;
      border-radius: 0 0 6px 0;
    }
    .skip-nav:focus {
      top: 0;
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Focus indicators */
    *:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Header */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .header-icon {
      width: 32px; height: 32px;
      background: var(--accent);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      color: white; font-weight: 700; font-size: 1rem;
    }

    header h1 {
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .header-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .header-subtitle {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }

    .user-menu-name {
      font-weight: 500;
    }

    .btn-logout {
      background: none;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.15s;
    }
    .btn-logout:hover {
      background: var(--bg);
      color: var(--text);
    }

    /* Main layout */
    main {
      max-width: 960px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* ── Auth views ─────────────────────────────── */
    .auth-container {
      max-width: 400px;
      margin: 4rem auto;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 2rem;
      box-shadow: var(--shadow);
    }

    .auth-container h2 {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 0.3rem;
      color: var(--text);
    }

    .form-group input {
      width: 100%;
      padding: 0.55rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.9rem;
      background: var(--surface);
      color: var(--text);
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-error {
      font-size: 0.8rem;
      color: var(--error);
      margin-top: 0.5rem;
      min-height: 1.2em;
    }

    .btn-submit {
      width: 100%;
      padding: 0.6rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
      margin-top: 0.5rem;
    }

    .btn-submit:hover { background: var(--accent-hover); }
    .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; }

    .auth-divider {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin: 1.25rem 0;
      color: var(--text-secondary);
      font-size: 0.8rem;
    }

    .auth-divider::before,
    .auth-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .btn-oauth {
      width: 100%;
      padding: 0.55rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface);
      color: var(--text);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.15s;
      margin-bottom: 0.5rem;
    }

    .btn-oauth:hover {
      background: var(--bg);
      border-color: #c9cdd4;
    }

    .auth-toggle {
      text-align: center;
      margin-top: 1.25rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .auth-toggle a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
    }

    .auth-toggle a:hover {
      text-decoration: underline;
    }

    /* ── Usage bar ──────────────────────────────── */
    .usage-bar-container {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .usage-label {
      font-size: 0.85rem;
      font-weight: 500;
      white-space: nowrap;
    }

    .usage-track {
      flex: 1;
      height: 8px;
      background: var(--bg);
      border-radius: 4px;
      overflow: hidden;
    }

    .usage-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .usage-fill.full {
      background: var(--error);
    }

    .usage-count {
      font-size: 0.8rem;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    /* ── Limit reached overlay ──────────────────── */
    .limit-reached {
      background: var(--warning-bg);
      border: 2px dashed var(--warning);
      border-radius: var(--radius);
      padding: 2.5rem;
      text-align: center;
      margin-bottom: 2rem;
    }

    .limit-reached-title {
      font-size: 1.05rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--warning);
    }

    .limit-reached-text {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .limit-reached-text a {
      color: var(--accent);
    }

    /* ── Upload zone ───────────────────────────── */
    .upload-section {
      background: var(--surface);
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 2.5rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      margin-bottom: 2rem;
    }

    .upload-section:hover, .upload-section.drag-over {
      border-color: var(--accent);
      background: #f8faff;
    }

    .upload-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
      opacity: 0.6;
    }

    .upload-title {
      font-size: 1.05rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .upload-hint {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .upload-section input[type="file"] {
      display: none;
    }

    /* Course context form */
    .context-bar {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .context-field {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }

    .context-field label {
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .context-field input {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.85rem;
      background: var(--surface);
      color: var(--text);
    }

    .context-field input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* Jobs list */
    .section-title {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
    }

    .jobs-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .job-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem 1.25rem;
      display: grid;
      grid-template-columns: 1fr auto;
      grid-template-rows: auto auto;
      gap: 0.25rem 1rem;
      align-items: center;
      box-shadow: var(--shadow);
      transition: box-shadow 0.2s;
    }

    .job-card:hover {
      box-shadow: var(--shadow-lg);
    }

    .job-filename {
      font-weight: 600;
      font-size: 0.95rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .job-meta {
      font-size: 0.8rem;
      color: var(--text-secondary);
      grid-column: 1;
    }

    .job-actions {
      grid-row: 1 / 3;
      grid-column: 2;
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    /* Status badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.2rem 0.6rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .badge-queued { background: #f3f4f6; color: #6b7280; }
    .badge-processing { background: #eff6ff; color: #2563eb; }
    .badge-completed { background: var(--success-bg); color: var(--success); }
    .badge-failed { background: var(--error-bg); color: var(--error); }

    .badge-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .badge-processing .badge-dot {
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Issue stats */
    .stats {
      display: flex;
      gap: 0.75rem;
      font-size: 0.8rem;
    }

    .stat { display: flex; align-items: center; gap: 0.25rem; }
    .stat-value { font-weight: 700; }
    .stat-fixed { color: var(--success); }
    .stat-remaining { color: var(--warning); }
    .stat-review { color: var(--accent); }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.4rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.15s;
      white-space: nowrap;
    }

    .btn:hover {
      background: var(--bg);
      border-color: #c9cdd4;
    }

    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-secondary);
    }

    .empty-state-icon { font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.4; }
    .empty-state-text { font-size: 0.9rem; }

    /* Report modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--surface);
      border-radius: 12px;
      width: 90vw;
      max-width: 960px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h2 {
      font-size: 1rem;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 0.25rem;
    }

    .modal-body {
      flex: 1;
      overflow: auto;
    }

    .modal-body iframe {
      width: 100%;
      height: 70vh;
      border: none;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--text);
      color: white;
      padding: 0.75rem 1.25rem;
      border-radius: 8px;
      font-size: 0.85rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateY(120%);
      transition: transform 0.3s ease;
      z-index: 200;
    }

    .toast.visible { transform: translateY(0); }

    /* View toggle */
    .hidden { display: none !important; }

    /* Responsive */
    @media (max-width: 640px) {
      main { padding: 1rem; }
      .context-bar { flex-direction: column; }
      .job-card { grid-template-columns: 1fr; }
      .job-actions { grid-column: 1; grid-row: auto; justify-content: flex-start; }
      .auth-container { margin: 2rem 1rem; }
    }
  </style>
</head>
<body>

<a class="skip-nav" href="#main-content">Skip to main content</a>

<header>
  <div class="header-icon" aria-hidden="true">A</div>
  <h1>A11y Remediation</h1>
  <div class="header-right">
    <span class="header-subtitle" id="headerSubtitle">WCAG 2.1 AA Document Accessibility</span>
    <div class="user-menu hidden" id="userMenu">
      <span class="user-menu-name" id="userDisplayName"></span>
      <button class="btn-logout" onclick="handleLogout()" aria-label="Sign out">Sign out</button>
    </div>
  </div>
</header>

<main id="main-content">

  <!-- ══ Auth View ══════════════════════════════════ -->
  <div id="authView" class="hidden">
    <!-- Login form -->
    <div class="auth-container" id="loginForm">
      <h2>Sign in</h2>
      <form onsubmit="handleLogin(event)" novalidate>
        <div class="form-group">
          <label for="loginEmail">Email address</label>
          <input type="email" id="loginEmail" autocomplete="email" required>
        </div>
        <div class="form-group">
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" autocomplete="current-password" required>
        </div>
        <div class="form-error" id="loginError" role="alert" aria-live="assertive"></div>
        <button type="submit" class="btn-submit" id="loginBtn">Sign in</button>
      </form>

      <div class="auth-divider">or</div>

      <button class="btn-oauth" onclick="oauthLogin('google')">
        Sign in with Google
      </button>
      <button class="btn-oauth" onclick="oauthLogin('microsoft')">
        Sign in with Microsoft
      </button>

      <div class="auth-toggle">
        Don't have an account? <a href="#" onclick="toggleAuthForm(event, 'signup')">Create one</a>
      </div>
    </div>

    <!-- Signup form -->
    <div class="auth-container hidden" id="signupForm">
      <h2>Create account</h2>
      <form onsubmit="handleSignup(event)" novalidate>
        <div class="form-group">
          <label for="signupName">Display name</label>
          <input type="text" id="signupName" autocomplete="name">
        </div>
        <div class="form-group">
          <label for="signupEmail">Email address</label>
          <input type="email" id="signupEmail" autocomplete="email" required>
        </div>
        <div class="form-group">
          <label for="signupPassword">Password</label>
          <input type="password" id="signupPassword" autocomplete="new-password" required
                 aria-describedby="passwordHint">
          <div id="passwordHint" style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.25rem">
            At least 8 characters
          </div>
        </div>
        <div class="form-error" id="signupError" role="alert" aria-live="assertive"></div>
        <button type="submit" class="btn-submit" id="signupBtn">Create account</button>
      </form>

      <div class="auth-divider">or</div>

      <button class="btn-oauth" onclick="oauthLogin('google')">
        Sign up with Google
      </button>
      <button class="btn-oauth" onclick="oauthLogin('microsoft')">
        Sign up with Microsoft
      </button>

      <div class="auth-toggle">
        Already have an account? <a href="#" onclick="toggleAuthForm(event, 'login')">Sign in</a>
      </div>
    </div>
  </div>

  <!-- ══ App View ═══════════════════════════════════ -->
  <div id="appView" class="hidden">

    <!-- Usage bar -->
    <div class="usage-bar-container" id="usageBar">
      <span class="usage-label">Documents</span>
      <div class="usage-track" role="progressbar" id="usageProgress"
           aria-valuenow="0" aria-valuemin="0" aria-valuemax="3"
           aria-label="Document usage">
        <div class="usage-fill" id="usageFill" style="width: 0%"></div>
      </div>
      <span class="usage-count" id="usageCount">0 of 3 used</span>
    </div>

    <!-- Limit reached -->
    <div class="limit-reached hidden" id="limitReached">
      <div class="limit-reached-title">Document limit reached</div>
      <div class="limit-reached-text">
        You've used all your free documents.
        Contact <a href="mailto:remediate@jenkleiman.com">remediate@jenkleiman.com</a> for early access to more.
      </div>
    </div>

    <!-- Course context -->
    <div class="context-bar" id="contextBar">
      <div class="context-field">
        <label for="courseName">Course name</label>
        <input type="text" id="courseName" placeholder="e.g., EMAT 8030">
      </div>
      <div class="context-field">
        <label for="department">Department</label>
        <input type="text" id="department" placeholder="e.g., Mathematics Education">
      </div>
    </div>

    <!-- Upload -->
    <div class="upload-section" id="dropZone" role="button" tabindex="0"
         aria-label="Upload area. Drop files here or press Enter to browse.">
      <div class="upload-icon" aria-hidden="true">&#128196;</div>
      <div class="upload-title">Drop files here or click to upload</div>
      <div class="upload-hint">Accepts .docx, .pdf, and .pptx files</div>
      <input type="file" id="fileInput" accept=".docx,.pdf,.pptx" multiple
             aria-label="Choose files to upload">
    </div>

    <!-- Jobs -->
    <h2 class="section-title">Documents</h2>
    <div class="jobs-list" id="jobsList" aria-live="polite">
      <div class="empty-state" id="emptyState">
        <div class="empty-state-icon" aria-hidden="true">&#128203;</div>
        <div class="empty-state-text">No documents yet. Upload a file to get started.</div>
      </div>
    </div>
  </div>

</main>

<!-- Report modal -->
<div class="modal-overlay" id="reportModal" role="dialog" aria-modal="true" aria-labelledby="reportTitle">
  <div class="modal">
    <div class="modal-header">
      <h2 id="reportTitle">Compliance Report</h2>
      <button class="modal-close" onclick="closeReport()" aria-label="Close report">&times;</button>
    </div>
    <div class="modal-body">
      <iframe id="reportFrame" title="Compliance Report"></iframe>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
const API = '';  // same origin
let pollTimer = null;
let currentUser = null;

// ── Auth state ──

async function checkAuth() {
  try {
    const res = await fetch(`${API}/api/auth/me`, { credentials: 'include' });
    if (res.ok) {
      const data = await res.json();
      currentUser = data.user;
      showAppView();
    } else {
      currentUser = null;
      showAuthView();
    }
  } catch (e) {
    currentUser = null;
    showAuthView();
  }
}

function showAuthView() {
  document.getElementById('authView').classList.remove('hidden');
  document.getElementById('appView').classList.add('hidden');
  document.getElementById('userMenu').classList.add('hidden');
  document.getElementById('headerSubtitle').classList.remove('hidden');
}

function showAppView() {
  document.getElementById('authView').classList.add('hidden');
  document.getElementById('appView').classList.remove('hidden');
  document.getElementById('headerSubtitle').classList.add('hidden');
  document.getElementById('userMenu').classList.remove('hidden');
  document.getElementById('userDisplayName').textContent = currentUser.display_name || currentUser.email;
  updateUsageBar();
  refreshJobs();
}

function updateUsageBar() {
  if (!currentUser) return;
  const used = currentUser.documents_used;
  const max = currentUser.max_documents;
  const pct = Math.min(100, (used / max) * 100);
  const fill = document.getElementById('usageFill');
  const progress = document.getElementById('usageProgress');
  const count = document.getElementById('usageCount');

  fill.style.width = pct + '%';
  fill.classList.toggle('full', used >= max);
  progress.setAttribute('aria-valuenow', used);
  progress.setAttribute('aria-valuemax', max);
  count.textContent = `${used} of ${max} used`;

  // Toggle upload vs limit-reached
  const limitReached = used >= max;
  document.getElementById('limitReached').classList.toggle('hidden', !limitReached);
  document.getElementById('dropZone').classList.toggle('hidden', limitReached);
  document.getElementById('contextBar').classList.toggle('hidden', limitReached);
}

function toggleAuthForm(e, target) {
  e.preventDefault();
  document.getElementById('loginForm').classList.toggle('hidden', target !== 'login');
  document.getElementById('signupForm').classList.toggle('hidden', target !== 'signup');
  // Clear errors
  document.getElementById('loginError').textContent = '';
  document.getElementById('signupError').textContent = '';
}

// ── Auth actions ──

async function handleLogin(e) {
  e.preventDefault();
  const btn = document.getElementById('loginBtn');
  const errEl = document.getElementById('loginError');
  errEl.textContent = '';

  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;

  if (!email || !password) {
    errEl.textContent = 'Email and password are required.';
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Signing in...';

  try {
    const res = await fetch(`${API}/api/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ email, password }),
    });

    const data = await res.json();
    if (res.ok) {
      currentUser = data.user;
      showAppView();
    } else {
      errEl.textContent = data.error || 'Login failed.';
    }
  } catch (e) {
    errEl.textContent = 'Network error. Please try again.';
  } finally {
    btn.disabled = false;
    btn.textContent = 'Sign in';
  }
}

async function handleSignup(e) {
  e.preventDefault();
  const btn = document.getElementById('signupBtn');
  const errEl = document.getElementById('signupError');
  errEl.textContent = '';

  const display_name = document.getElementById('signupName').value.trim();
  const email = document.getElementById('signupEmail').value.trim();
  const password = document.getElementById('signupPassword').value;

  if (!email || !password) {
    errEl.textContent = 'Email and password are required.';
    return;
  }

  if (password.length < 8) {
    errEl.textContent = 'Password must be at least 8 characters.';
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Creating account...';

  try {
    const res = await fetch(`${API}/api/auth/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ email, password, display_name }),
    });

    const data = await res.json();
    if (res.ok) {
      currentUser = data.user;
      showAppView();
    } else {
      errEl.textContent = data.error || 'Registration failed.';
    }
  } catch (e) {
    errEl.textContent = 'Network error. Please try again.';
  } finally {
    btn.disabled = false;
    btn.textContent = 'Create account';
  }
}

async function handleLogout() {
  try {
    await fetch(`${API}/api/auth/logout`, {
      method: 'POST',
      credentials: 'include',
    });
  } catch (e) {
    // Ignore network errors on logout
  }
  currentUser = null;
  if (pollTimer) {
    clearInterval(pollTimer);
    pollTimer = null;
  }
  showAuthView();
}

async function oauthLogin(provider) {
  try {
    const res = await fetch(`${API}/api/auth/${provider}`, { credentials: 'include' });
    const data = await res.json();
    if (data.url) {
      window.location.href = data.url;
    } else {
      showToast(data.error || `${provider} login not available`);
    }
  } catch (e) {
    showToast(`${provider} login not available`);
  }
}

// ── Upload handling ──

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    fileInput.click();
  }
});

dropZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropZone.classList.add('drag-over');
});

dropZone.addEventListener('dragleave', () => {
  dropZone.classList.remove('drag-over');
});

dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');
  handleFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', () => {
  handleFiles(fileInput.files);
  fileInput.value = '';
});

async function handleFiles(files) {
  // Pre-flight usage check
  if (currentUser && currentUser.documents_used >= currentUser.max_documents) {
    showToast('Document limit reached.');
    return;
  }

  const courseName = document.getElementById('courseName').value;
  const department = document.getElementById('department').value;

  for (const file of files) {
    // Client-side size check
    if (currentUser && file.size > currentUser.max_file_size_mb * 1024 * 1024) {
      showToast(`${file.name} exceeds ${currentUser.max_file_size_mb}MB limit`);
      continue;
    }

    const formData = new FormData();
    formData.append('file', file);
    formData.append('course_name', courseName);
    formData.append('department', department);

    try {
      const res = await fetch(`${API}/api/upload`, {
        method: 'POST',
        body: formData,
        credentials: 'include',
      });

      if (res.status === 401) {
        showAuthView();
        return;
      }

      if (!res.ok) {
        const err = await res.json();
        showToast(err.error || 'Upload failed');
        continue;
      }

      const data = await res.json();
      showToast(`Uploaded: ${file.name}`);
    } catch (e) {
      showToast(`Error uploading ${file.name}`);
    }
  }

  // Refresh user data (usage count) and jobs
  await checkAuth();
  startPolling();
}

// ── Jobs list ──

async function refreshJobs() {
  try {
    const res = await fetch(`${API}/api/jobs`, { credentials: 'include' });
    if (res.status === 401) {
      showAuthView();
      return;
    }
    const data = await res.json();
    renderJobs(data.jobs);

    // Stop polling if no active jobs
    const hasActive = data.jobs.some(j => j.status === 'queued' || j.status === 'processing');
    if (!hasActive && pollTimer) {
      clearInterval(pollTimer);
      pollTimer = null;
    }
  } catch (e) {
    console.error('Failed to fetch jobs', e);
  }
}

function startPolling() {
  if (pollTimer) return;
  pollTimer = setInterval(refreshJobs, 3000);
}

function renderJobs(jobs) {
  const list = document.getElementById('jobsList');
  const empty = document.getElementById('emptyState');

  if (jobs.length === 0) {
    list.innerHTML = '';
    list.appendChild(empty);
    return;
  }

  list.innerHTML = jobs.map(job => {
    const badge = statusBadge(job.status);
    const meta = buildMeta(job);
    const actions = buildActions(job);

    return `
      <div class="job-card">
        <div class="job-filename">${esc(job.filename)}</div>
        <div class="job-actions">${badge}${actions}</div>
        <div class="job-meta">${meta}</div>
      </div>
    `;
  }).join('');
}

function statusBadge(status) {
  const labels = {
    queued: 'Queued',
    processing: 'Processing',
    completed: 'Completed',
    failed: 'Failed',
  };
  return `<span class="badge badge-${status}"><span class="badge-dot" aria-hidden="true"></span>${labels[status] || status}</span>`;
}

function buildMeta(job) {
  const parts = [];
  if (job.course_name) parts.push(job.course_name);
  if (job.status === 'completed') {
    parts.push(`${job.processing_time}s`);
    parts.push(`<span class="stats">
      <span class="stat"><span class="stat-value stat-fixed">${job.issues_fixed}</span> fixed</span>
      <span class="stat"><span class="stat-value stat-remaining">${job.issues_after}</span> remaining</span>
      <span class="stat"><span class="stat-value stat-review">${job.human_review_count}</span> review</span>
    </span>`);
  }
  if (job.status === 'failed' && job.error) {
    parts.push(`<span style="color:var(--error)">${esc(job.error.substring(0, 80))}</span>`);
  }
  return parts.join(' &middot; ');
}

function buildActions(job) {
  if (job.status !== 'completed') return '';
  return `
    <button class="btn" onclick="viewReport('${job.id}', '${esc(job.filename)}')">Report</button>
    <a class="btn btn-primary" href="${API}/api/jobs/${job.id}/download">Download</a>
  `;
}

// ── Report viewer ──

function viewReport(jobId, filename) {
  document.getElementById('reportTitle').textContent = `Report — ${filename}`;
  document.getElementById('reportFrame').src = `${API}/api/jobs/${jobId}/report`;
  document.getElementById('reportModal').classList.add('active');
}

function closeReport() {
  document.getElementById('reportModal').classList.remove('active');
  document.getElementById('reportFrame').src = '';
}

document.getElementById('reportModal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeReport();
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeReport();
});

// ── Helpers ──

function esc(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('visible');
  setTimeout(() => toast.classList.remove('visible'), 3000);
}

// ── Initial load ──
checkAuth();
</script>
</body>
</html>
